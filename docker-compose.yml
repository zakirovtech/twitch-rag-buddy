services:
  twitch-redis:
    image: redis:7-alpine
    container_name: twitch-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    networks:
      - supabase_n8n_network

  twitch-gateway:
    build:
      context: ./twitch_gateway
    container_name: twitch-gateway
    restart: unless-stopped
    volumes:
      - ./twitch_gateway/tokens.json:/app/tokens.json:rw
    environment:
      # Twitch IRC
      - TWITCH_NICK=${TWITCH_NICK}
      - TWITCH_OAUTH=${TWITCH_OAUTH} # backoff (delete later)
      - TWITCH_CHANNELS=${TWITCH_CHANNELS}
      - TWITCH_TOKEN_FILE=${TWITCH_TOKEN_FILE}
      - TWITCH_APP_CLIENT_ID=${TWITCH_APP_CLIENT_ID}
      - TWITCH_APP_CLIENT_SECRET=${TWITCH_APP_CLIENT_SECRET}
      - TWITCH_TOKEN_MIN_TTL_SEC=${TWITCH_TOKEN_MIN_TTL_SEC}

      # Redis
      - REDIS_URL=${REDIS_URL}

      # Streams
      - REDIS_STREAM_IN=${REDIS_STREAM_IN}
      - REDIS_STREAM_OUT=${REDIS_STREAM_OUT}
      - REDIS_CONSUMER_GROUP=${REDIS_CONSUMER_GROUP}
      - REDIS_CONSUMER_NAME=${REDIS_CONSUMER_NAME}

      # Rate limit (twitch обычно 20/30s)
      - RATE_LIMIT_COUNT=${RATE_LIMIT_COUNT}
      - RATE_LIMIT_WINDOW_SEC=${RATE_LIMIT_WINDOW_SEC}

      - LOG_LEVEL=${LOG_LEVEL}
    depends_on:
      - twitch-redis
    networks:
      - supabase_n8n_network

  twitch-ai-chat-brain:
    build:
      context: ./ai_chat_brain
    container_name: ai-chat-brain
    restart: unless-stopped
    environment:
      - REDIS_URL=${REDIS_URL}
      - REDIS_STREAM_IN=${REDIS_STREAM_IN}
      - REDIS_STREAM_OUT=${REDIS_STREAM_OUT}
      - REDIS_CONSUMER_GROUP_IN=${REDIS_CONSUMER_GROUP_IN}
      - REDIS_CONSUMER_NAME_IN=${REDIS_CONSUMER_NAME_IN}

      # Логика brain
      - BOT_NICK=${BOT_NICK}
      - CHANNEL_ALLOWLIST=${CHANNEL_ALLOWLIST}
      - BANWORDS=${BANWORDS}
      - MIN_TEXT_LEN=${MIN_TEXT_LEN}
      - BATCH_SEC=${BATCH_SEC}
      - SPEAK_EVERY_SEC=${SPEAK_EVERY_SEC}
      - MAX_OUT_LEN=${MAX_OUT_LEN}
      - LOG_LEVEL=${LOG_LEVEL}
      
      - OLLAMA_URL=${OLLAMA_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_TEMPERATURE=${OLLAMA_TEMPERATURE}
      - OLLAMA_NUM_CTX=${OLLAMA_NUM_CTX}
      - OLLAMA_NUM_PREDICT=${OLLAMA_NUM_PREDICT}
      - OLLAMA_TOP_P=${OLLAMA_TOP_P}
      - OLLAMA_REPEAT_PENALTY=${OLLAMA_REPEAT_PENALTY}
      - OLLAMA_FORCE_RU=${OLLAMA_FORCE_RU}
      - OLLAMA_RETRY_NON_RU=${OLLAMA_RETRY_NON_RU}
      - OLLAMA_TIMEOUT_SEC=${OLLAMA_TIMEOUT_SEC}
    depends_on:
      - twitch-redis
    networks:
      - supabase_n8n_network

networks:
  supabase_n8n_network:
    external: true